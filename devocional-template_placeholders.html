<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Devocional - Reflexi√≥n para cada d√≠a</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700;900&family=Poppins:wght@600;700;800&family=Playfair+Display:ital,wght@0,500;1,500&display=swap" rel="stylesheet">

  <!-- CSS Variables y Estilos -->
  <link rel="stylesheet" href="css/common-variables.css">
  <link rel="stylesheet" href="css/variables-{{css_variant}}.css">
  <link rel="stylesheet" href="css/general.css">
</head>
<body>

<article class="devocional">
  <!-- HEADER -->
  <header class="devocional__header">
    <img
      src="images/{{cover_image}}"
      alt="Amanecer sobre monta√±as"
      class="devocional__header-imagen"
    >
    <div class="devocional__header-overlay">
      <h1 class="devocional__titulo">DEVOCIONAL</h1>
      <p class="devocional__subtitulo">REFLEXI√ìN PARA CADA D√çA</p>
    </div>
  </header>

  <!-- FECHA -->
  <div class="devocional__fecha">
    <span class="devocional__fecha-texto">{{date}}</span>
  </div>

  <!-- T√çTULO DEL DEVOCIONAL -->
  <div class="devocional__titulo-wrapper">
    <h2 class="devocional__contenido-titulo">{{devotional_title}}</h2>
  </div>

  <!-- BOT√ìN DESCARGAR PNG -->
  <button class="devocional__download-btn no-screenshot" onclick="downloadAsPNG()">
    üì• Descargar como imagen
  </button>

  <!-- REPRODUCTOR DE AUDIO -->
  <div class="devocional__audio-player no-screenshot" id="audioPlayer">
    <div class="devocional__audio-loading" id="audioLoading">
      Cargando audio...
    </div>
    <div class="devocional__audio-error" id="audioError" style="display: none;">
      üîá Audio no disponible
    </div>
    <div class="devocional__audio-controls" id="audioControls">
      <audio controls preload="metadata" id="audioElement">
        <source id="audioSource" type="audio/mpeg">
        Tu navegador no soporta el elemento de audio.
      </audio>
    </div>
  </div>

  <!-- CITA B√çBLICA BADGE -->
  <div class="devocional__cita-badge">
    {{verse_ref}}
  </div>

  <!-- VERS√çCULO PRINCIPAL -->
  <section class="devocional__versiculo-section">
    <blockquote class="devocional__versiculo">
      {{verse_text}}
    </blockquote>
  </section>

  <!-- ETIQUETA TESORO B√çBLICO -->
  <div class="devocional__etiqueta-badge">
    Tesoro B√≠blico
  </div>

  <!-- CONTENIDO PRINCIPAL -->
  <div class="devocional__contenido">
    {{biblical_treasure}}
  </div>

  <!-- PUNTO DE ACCI√ìN -->
  <section class="devocional__accion">
    <h3 class="devocional__accion-titulo">Punto de Acci√≥n</h3>
    <div class="devocional__accion-contenido">
      {{call_to_action}}
    </div>
  </section>

  <!-- FOOTER -->
  <footer class="devocional__footer">
    ¬© 2025 ¬∑ Devocionales Diarios ¬∑ Que tu d√≠a sea bendecido
  </footer>
</article>

<script>
  // ============================================
  // CONFIGURACI√ìN
  // ============================================
  const AUDIO_SERVER_URL = '{{audio_server_url}}';
  const AUDIO_FILENAME = '{{audio_filename}}';
  const PNG_FILENAME = '{{png_filename}}';

  // ============================================
  // CARGA DE AUDIO
  // ============================================
  async function loadAudio() {
    const audioLoading = document.getElementById('audioLoading');
    const audioError = document.getElementById('audioError');
    const audioControls = document.getElementById('audioControls');
    const audioSource = document.getElementById('audioSource');
    const audioElement = document.getElementById('audioElement');

    try {
      // Construir URL del audio (generado est√°ticamente durante build)
      const audioUrl = `${AUDIO_SERVER_URL}${AUDIO_FILENAME}`;

      // Verificar si el audio existe
      const response = await fetch(audioUrl, { method: 'HEAD' });

      if (response.ok) {
        // El audio existe, configurar el reproductor
        audioSource.src = audioUrl;
        audioElement.load();

        // Mostrar controles cuando el audio est√© listo
        audioElement.addEventListener('loadedmetadata', () => {
          audioLoading.style.display = 'none';
          audioControls.classList.add('loaded');
        });

        // Manejar errores de carga
        audioElement.addEventListener('error', () => {
          audioLoading.style.display = 'none';
          audioError.style.display = 'block';
        });

      } else {
        // El audio no existe
        audioLoading.style.display = 'none';
        audioError.style.display = 'block';
      }

    } catch (error) {
      console.error('Error al cargar audio:', error);
      audioLoading.style.display = 'none';
      audioError.style.display = 'block';
    }
  }

  // Cargar el audio cuando la p√°gina est√© lista
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadAudio);
  } else {
    loadAudio();
  }

  // ============================================
  // DESCARGA DE IMAGEN
  // ============================================
  async function downloadAsPNG() {
    const button = document.querySelector('.devocional__download-btn');

    // Desactivar bot√≥n mientras se procesa
    button.disabled = true;
    button.textContent = '‚è≥ Descargando...';

    try {
      // Usar el nombre del archivo PNG generado est√°ticamente durante build
      const pngFilename = PNG_FILENAME;

      // Intentar descargar el PNG que ya existe
      const response = await fetch(pngFilename);

      if (response.ok) {
        // El PNG existe, descargarlo directamente
        const blob = await response.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = pngFilename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        // Restaurar bot√≥n
        button.disabled = false;
        button.textContent = 'üì• Descargar como imagen';
      } else {
        // El PNG no existe, mostrar mensaje
        throw new Error('IMAGE_NOT_FOUND');
      }

    } catch (error) {
      console.error('Error al descargar imagen:', error);

      if (error.message === 'IMAGE_NOT_FOUND') {
        alert('‚ö†Ô∏è Imagen PNG no encontrada.\n\n' +
              'Para generar las im√°genes PNG, ejecuta:\n' +
              'DEVO_GENERATE_IMAGES=true node parse-devotional-json.js');
      } else {
        alert('Error al descargar la imagen. Verifica que el archivo PNG existe en la misma carpeta.');
      }

      // Restaurar bot√≥n
      button.disabled = false;
      button.textContent = 'üì• Descargar como imagen';
    }
  }
</script>

</body>
</html>
